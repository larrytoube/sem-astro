---
import { getCollection } from 'astro:content'
import SEMLayout from '../../layouts/SEMLayout.astro'
import SEMCTASection from '../../components/sem/SEMCTASection.astro'

function toSlug(id: string) {
  return id.replace(/\/index\.(mdoc|mdx|md)$/, '').replace(/\.(mdoc|mdx|md)$/, '').replace(/\.md$/, '')
}

function csImage(filename?: string) {
  return filename ? `/images/case-studies/${filename}` : undefined
}

export async function getStaticPaths() {
  const studies = await getCollection('case-studies')
  return studies.map(study => ({
    params: { slug: study.id.replace(/\/index\.(mdoc|mdx|md)$/, '').replace(/\.(mdoc|mdx|md)$/, '').replace(/\.md$/, '') },
    props: { study },
  }))
}

const { study } = Astro.props
const { Content } = await study.render()
const { title, client, category, description, date, duration, heroImage, logo, gallery, relatedStudies } = study.data

// Fetch related case studies
const allStudies = await getCollection('case-studies')
const related = relatedStudies
  .map(slug => allStudies.find(s => toSlug(s.id) === slug))
  .filter(Boolean)
---

<SEMLayout
  title={`${client} â€” Case Study`}
  description={description}
>
  <!-- Hero -->
  <section class="relative">
    <!-- Hero Image -->
    <div class="relative h-[50vh] min-h-[400px] w-full overflow-hidden">
      <img
        src={csImage(heroImage)}
        alt={title}
        class="h-full w-full object-cover"
        loading="eager"
      />
      <div class="absolute inset-0 bg-gradient-to-b from-black/20 via-transparent to-black/40" />
    </div>

    <!-- Hero Content Grid -->
    <div class="mx-auto max-w-7xl px-6">
      <div class="relative -mt-24 grid gap-8 lg:grid-cols-[1fr_1.2fr]">
        <!-- Category Label + Title -->
        <div class="rounded-2xl bg-white p-8 shadow-card-hover">
          <p class="section-label mb-4">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M14.25 6.087c0-.355.186-.676.401-.959.221-.29.349-.634.349-1.003 0-1.036-1.007-1.875-2.25-1.875s-2.25.84-2.25 1.875c0 .369.128.713.349 1.003.215.283.401.604.401.959v0a.64.64 0 01-.657.643 48.39 48.39 0 01-4.163-.3c.186 1.613.293 3.25.315 4.907a.656.656 0 01-.658.663v0c-.355 0-.676-.186-.959-.401a1.647 1.647 0 00-1.003-.349c-1.036 0-1.875 1.007-1.875 2.25s.84 2.25 1.875 2.25c.369 0 .713-.128 1.003-.349.283-.215.604-.401.959-.401v0c.31 0 .555.26.532.57a48.039 48.039 0 01-.642 5.056c1.518.19 3.058.309 4.616.354a.64.64 0 00.657-.643v0c0-.355-.186-.676-.401-.959a1.647 1.647 0 01-.349-1.003c0-1.035 1.008-1.875 2.25-1.875 1.243 0 2.25.84 2.25 1.875 0 .369-.128.713-.349 1.003-.215.283-.401.604-.401.959v0c0 .333.277.599.61.58a48.1 48.1 0 005.427-.63 48.05 48.05 0 00.582-4.717.532.532 0 00-.533-.57v0c-.355 0-.676.186-.959.401-.29.221-.634.349-1.003.349-1.035 0-1.875-1.007-1.875-2.25s.84-2.25 1.875-2.25c.37 0 .713.128 1.003.349.283.215.604.401.959.401v0a.656.656 0 00.658-.663 48.422 48.422 0 00-.37-5.36c-1.886.342-3.81.574-5.766.689a.578.578 0 01-.61-.58v0z" />
            </svg>
            {category.toUpperCase()}
          </p>
          <h1 class="font-accent text-h2 font-medium text-heading md:text-h1">{title}</h1>
        </div>

        <!-- Description + Metadata -->
        <div class="flex flex-col justify-end rounded-2xl bg-bg-light p-8">
          <p class="text-body-lg leading-relaxed text-text-body">{description}</p>
          <div class="mt-8 grid grid-cols-2 gap-6 sm:grid-cols-4">
            <div>
              <p class="text-xs font-medium uppercase tracking-wider text-text-muted">Client</p>
              <p class="mt-1 font-medium text-heading">{client}</p>
            </div>
            <div>
              <p class="text-xs font-medium uppercase tracking-wider text-text-muted">Project Type</p>
              <p class="mt-1 font-medium text-heading">{category}</p>
            </div>
            {date && (
              <div>
                <p class="text-xs font-medium uppercase tracking-wider text-text-muted">Date</p>
                <p class="mt-1 font-medium text-heading">{date}</p>
              </div>
            )}
            {duration && (
              <div>
                <p class="text-xs font-medium uppercase tracking-wider text-text-muted">Duration</p>
                <p class="mt-1 font-medium text-heading">{duration}</p>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Body Content -->
  <section class="px-6 py-20">
    <div class="prose-sem mx-auto max-w-4xl">
      <Content />
    </div>
  </section>

  <!-- Gallery -->
  {gallery.length > 0 && (
    <section class="px-6 pb-20">
      <div class="mx-auto max-w-7xl">
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          {gallery.map(img => (
            <div class="overflow-hidden rounded-xl">
              <img
                src={csImage(img.src)}
                alt={img.alt}
                class="h-64 w-full object-cover transition-transform duration-500 hover:scale-105"
                loading="lazy"
              />
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Related Case Studies -->
  {related.length > 0 && (
    <section class="bg-bg-light px-6 py-20">
      <div class="mx-auto max-w-7xl">
        <div class="mb-12">
          <p class="section-label mb-4">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
            </svg>
            RELATED WORK
          </p>
          <h2 class="font-accent text-h2 font-medium text-heading">Explore Related Case Studies</h2>
          <p class="mt-4 text-body-lg text-text-body">See how we've transformed brands and driven results.</p>
        </div>
        <div class="grid gap-8 md:grid-cols-2">
          {related.map(r => (
            <a
              href={`/case-studies/${toSlug(r!.id)}`}
              class="group relative flex overflow-hidden rounded-2xl bg-white shadow-card transition-all duration-300 hover:shadow-card-hover"
            >
              <div class="relative h-48 w-48 flex-shrink-0 overflow-hidden">
                <img
                  src={csImage(r!.data.heroImage)}
                  alt={r!.data.title}
                  class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
                  loading="lazy"
                />
                {r!.data.logo && (
                  <div class="absolute inset-0 flex items-center justify-center bg-teal-dark/80 opacity-0 transition-opacity duration-300 group-hover:opacity-100">
                    <img src={csImage(r!.data.logo)} alt={r!.data.client} class="h-14 w-auto max-w-[70%] object-contain brightness-0 invert" loading="lazy" />
                  </div>
                )}
              </div>
              <div class="flex flex-1 flex-col justify-center p-6">
                <h3 class="font-accent text-h4 font-medium text-heading transition-colors group-hover:text-teal-solid">{r!.data.title}</h3>
                <p class="mt-2 text-sm leading-relaxed text-text-body line-clamp-2">{r!.data.description}</p>
                <div class="mt-3 flex items-center gap-1 text-sm font-medium text-teal-solid">
                  View Case Study
                  <svg class="h-4 w-4 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 17L17 7M17 7H7M17 7v10" />
                  </svg>
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- CTA -->
  <SEMCTASection
    title="Transformative Projects That Drive Results"
    description="Each case study represents a unique challenge, and successful outcome. Versatile experience across diverse projects, bringing adaptability and valuable skills to any task."
    ctaText="Start a Conversation"
    ctaHref="/contact"
  />
</SEMLayout>

<style is:global>
  /* Prose styles for case study body content */
  .prose-sem h2 {
    font-family: var(--font-accent);
    font-size: var(--text-h3);
    line-height: var(--text-h3--line-height);
    font-weight: 500;
    color: var(--color-heading);
    margin-top: 2.5rem;
    margin-bottom: 1rem;
  }
  .prose-sem h2:first-child {
    margin-top: 0;
  }
  .prose-sem p {
    font-size: var(--text-body-lg);
    line-height: 1.7;
    color: var(--color-text-body);
    margin-bottom: 1.25rem;
  }
  .prose-sem ul, .prose-sem ol {
    margin-bottom: 1.25rem;
    padding-left: 1.5rem;
  }
  .prose-sem li {
    font-size: var(--text-body-lg);
    line-height: 1.7;
    color: var(--color-text-body);
    margin-bottom: 0.5rem;
  }
  .prose-sem ul li {
    list-style-type: disc;
  }
  .prose-sem strong {
    color: var(--color-heading);
    font-weight: 600;
  }
</style>
