---
import { getCollection } from 'astro:content'
import SEMLayout from '../../layouts/SEMLayout.astro'
import SEMHero from '../../components/sem/SEMHero.astro'
import SEMBlogCard from '../../components/sem/SEMBlogCard.astro'
import SEMCTASection from '../../components/sem/SEMCTASection.astro'

function toSlug(id: string) {
  return id.replace(/\/index\.(mdoc|mdx|md)$/, '').replace(/\.(mdoc|mdx|md)$/, '')
}

const posts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => b.data.publishedAt.valueOf() - a.data.publishedAt.valueOf())

const categories = [
  { label: 'All', value: 'all' },
  { label: 'Digital Marketing', value: 'digital-marketing' },
  { label: 'SEO', value: 'seo' },
  { label: 'AI', value: 'ai' },
  { label: 'Data Analytics', value: 'data-analytics' },
  { label: 'Workflow Optimization', value: 'workflow-optimization' },
  { label: 'Marketing Strategy', value: 'marketing-strategy' },
  { label: 'Brand Strategy', value: 'brand-strategy' },
  { label: 'Paid Advertising', value: 'paid-advertising' },
  { label: 'Social Media', value: 'social-media' },
  { label: 'Creative Design', value: 'creative-design' },
]

const categoryLabels: Record<string, string> = Object.fromEntries(
  categories.map(c => [c.value, c.label])
)

const [featured, ...rest] = posts

function formatDate(date: Date) {
  return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
}

function blogImage(filename?: string) {
  return filename ? `/images/blog/${filename}` : undefined
}
---

<SEMLayout
  title="Blog"
  description="Marketing insights, strategies, and tips from the Sharp End Marketing team."
>
  <SEMHero
    label="INSIGHTS"
    title="Marketing Insights & Inspiration"
    subtitle="Stay ahead with the latest marketing trends, strategies, and insights from our team."
    icon="search"
  />

  <section class="px-6 py-12">
    <div class="mx-auto max-w-7xl">
      <!-- Category Filter Pills -->
      <div class="flex flex-wrap justify-center gap-3" id="category-filters">
        {categories.map(cat => (
          <button
            data-category={cat.value}
            class:list={[
              'filter-pill rounded-full px-5 py-2 text-sm font-medium transition-colors',
              cat.value === 'all'
                ? 'bg-teal-solid text-white'
                : 'bg-bg-light text-text-body hover:bg-teal-solid hover:text-white',
            ]}
          >
            {cat.label}
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Blog Posts -->
  <section class="px-6 pb-20">
    <div class="mx-auto max-w-7xl">
      <h2 class="sr-only">Blog Posts</h2>
      <div id="blog-posts">
        <!-- Featured Post -->
        {featured && (
          <div class="mb-8" data-post-category={featured.data.category}>
            <SEMBlogCard
              title={featured.data.title}
              description={featured.data.description}
              category={categoryLabels[featured.data.category] || featured.data.category}
              date={formatDate(featured.data.publishedAt)}
              href={`/blog/${toSlug(featured.id)}`}
              image={blogImage(featured.data.image)}
              featured={true}
            />
          </div>
        )}

        <!-- Post Grid -->
        <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
          {rest.map(post => (
            <div data-post-category={post.data.category}>
              <SEMBlogCard
                title={post.data.title}
                description={post.data.description}
                category={categoryLabels[post.data.category] || post.data.category}
                date={formatDate(post.data.publishedAt)}
                href={`/blog/${toSlug(post.id)}`}
                image={blogImage(post.data.image)}
              />
            </div>
          ))}
        </div>
      </div>
    </div>
  </section>

  <SEMCTASection
    title="Ready to Elevate Your Brand?"
    description="Partner with Sharp End and let's create something extraordinary together."
    ctaText="Get in Touch"
    ctaHref="/contact"
  />
</SEMLayout>

<script>
  const buttons = document.querySelectorAll<HTMLButtonElement>('.filter-pill')
  const posts = document.querySelectorAll<HTMLElement>('[data-post-category]')

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const category = btn.dataset.category

      // Update active pill
      buttons.forEach(b => {
        b.classList.remove('bg-teal-solid', 'text-white')
        b.classList.add('bg-bg-light', 'text-text-body')
      })
      btn.classList.remove('bg-bg-light', 'text-text-body')
      btn.classList.add('bg-teal-solid', 'text-white')

      // Filter posts
      posts.forEach(post => {
        if (category === 'all' || post.dataset.postCategory === category) {
          post.style.display = ''
        } else {
          post.style.display = 'none'
        }
      })
    })
  })
</script>
