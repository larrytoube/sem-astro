---
import { getCollection, render } from 'astro:content'
import SEMLayout from '../../layouts/SEMLayout.astro'
import SEMBlogCard from '../../components/sem/SEMBlogCard.astro'
import SEMCTASection from '../../components/sem/SEMCTASection.astro'

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft)
  return posts.map(post => ({
    params: { slug: post.id.replace(/\/index\.(mdoc|mdx|md)$/, '').replace(/\.(mdoc|mdx|md)$/, '') },
    props: { post },
  }))
}

function toSlug(id: string) {
  return id.replace(/\/index\.(mdoc|mdx|md)$/, '').replace(/\.(mdoc|mdx|md)$/, '')
}

const { post } = Astro.props
const { Content } = await render(post)

const categoryLabels: Record<string, string> = {
  'digital-marketing': 'Digital Marketing',
  'seo': 'SEO',
  'social-media': 'Social Media',
  'workflow-optimization': 'Workflow Optimization',
  'data-analytics': 'Data Analytics',
  'brand-strategy': 'Brand Strategy',
  'paid-advertising': 'Paid Advertising',
  'creative-design': 'Creative Design',
  'ai': 'AI',
  'marketing-strategy': 'Marketing Strategy',
}

const categoryLabel = categoryLabels[post.data.category] || post.data.category

// Get related posts (same category, excluding current)
const allPosts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => b.data.publishedAt.valueOf() - a.data.publishedAt.valueOf())

let related = allPosts
  .filter(p => p.id !== post.id && p.data.category === post.data.category)
  .slice(0, 3)

// If not enough same-category posts, fill with latest
if (related.length < 3) {
  const remaining = allPosts
    .filter(p => p.id !== post.id && !related.some(r => r.id === p.id))
    .slice(0, 3 - related.length)
  related = [...related, ...remaining]
}

function formatDate(date: Date) {
  return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })
}

function formatDateShort(date: Date) {
  return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
}

function blogImage(filename?: string) {
  return filename ? `/images/blog/${filename}` : undefined
}
---

<SEMLayout
  title={post.data.title}
  description={post.data.description}
  ogImage={blogImage(post.data.image)}
>
  <article>
    <!-- Breadcrumbs -->
    <nav class="px-6 pt-24 pb-4" aria-label="Breadcrumb">
      <div class="mx-auto max-w-4xl">
        <ol class="flex items-center gap-2 text-sm text-text-muted">
          <li><a href="/blog" class="hover:text-teal-solid transition-colors">Blog</a></li>
          <li><span class="mx-1">/</span></li>
          <li><a href={`/blog?category=${post.data.category}`} class="hover:text-teal-solid transition-colors">{categoryLabel}</a></li>
          <li><span class="mx-1">/</span></li>
          <li class="truncate text-text-body">{post.data.title}</li>
        </ol>
      </div>
    </nav>

    <!-- Header -->
    <header class="px-6 pb-8">
      <div class="mx-auto max-w-4xl">
        <span class="inline-block rounded-full bg-teal-solid/10 px-3 py-1 text-xs font-medium text-teal-solid">
          {categoryLabel}
        </span>
        <h1 class="mt-4 font-accent text-h1 font-medium text-heading">
          {post.data.title}
        </h1>
        <p class="mt-4 text-lead text-text-body">{post.data.description}</p>

        <!-- Author & Date -->
        <div class="mt-6 flex items-center gap-4">
          <div class="flex h-10 w-10 items-center justify-center rounded-full bg-teal-solid text-sm font-bold text-white">
            {post.data.author.split(' ').map(n => n[0]).join('')}
          </div>
          <div>
            <p class="text-sm font-medium text-heading">{post.data.author}</p>
            <p class="text-xs text-text-muted">{formatDate(post.data.publishedAt)}</p>
          </div>
        </div>
      </div>
    </header>

    <!-- Hero Image -->
    {post.data.image && (
      <div class="px-6 pb-12">
        <div class="mx-auto max-w-5xl overflow-hidden rounded-2xl">
          <img
            src={blogImage(post.data.image)}
            alt={post.data.title}
            class="h-auto w-full object-cover"
            loading="eager"
          />
        </div>
      </div>
    )}

    <!-- Content -->
    <div class="px-6 pb-16">
      <div class="prose prose-lg mx-auto max-w-4xl">
        <Content />
      </div>
    </div>
  </article>

  <!-- Related Posts -->
  {related.length > 0 && (
    <section class="bg-bg-light px-6 py-20">
      <div class="mx-auto max-w-7xl">
        <h2 class="mb-8 font-accent text-h3 font-medium text-heading">Related Articles</h2>
        <div class="grid gap-8 md:grid-cols-3">
          {related.map(p => (
            <SEMBlogCard
              title={p.data.title}
              description={p.data.description}
              category={categoryLabels[p.data.category] || p.data.category}
              date={formatDateShort(p.data.publishedAt)}
              href={`/blog/${toSlug(p.id)}`}
              image={blogImage(p.data.image)}
            />
          ))}
        </div>
      </div>
    </section>
  )}

  <SEMCTASection
    title="Ready to Elevate Your Brand?"
    description="Partner with Sharp End and let's create something extraordinary together."
    ctaText="Get in Touch"
    ctaHref="/contact"
  />
</SEMLayout>

<style is:global>
  .prose {
    color: var(--color-text-body);
    line-height: 1.8;
  }
  .prose h2 {
    font-family: var(--font-heading);
    color: var(--color-heading);
    font-size: 1.75rem;
    font-weight: 500;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
  }
  .prose h3 {
    font-family: var(--font-heading);
    color: var(--color-heading);
    font-size: 1.375rem;
    font-weight: 500;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }
  .prose p {
    margin-bottom: 1.25rem;
  }
  .prose ul, .prose ol {
    margin-bottom: 1.25rem;
    padding-left: 1.5rem;
  }
  .prose ul {
    list-style-type: disc;
  }
  .prose ol {
    list-style-type: decimal;
  }
  .prose li {
    margin-bottom: 0.5rem;
  }
  .prose strong {
    color: var(--color-heading);
    font-weight: 600;
  }
  .prose blockquote {
    border-left: 4px solid var(--color-teal-solid);
    padding-left: 1.5rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: var(--color-text-muted);
  }
  .prose a {
    color: var(--color-teal-solid);
    text-decoration: underline;
  }
  .prose a:hover {
    color: var(--color-teal-dark);
  }
  .prose img {
    border-radius: 0.75rem;
    margin: 1.5rem 0;
  }
</style>
